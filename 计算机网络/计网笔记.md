



# 链路层

## 以太网帧格式

![以太帧结构（格式）](http://c.biancheng.net/uploads/allimg/191106/6-191106130541362.gif)



## ARP协议

+ 位置:链路层和网络层中间, 归于网络层

+ ARP高速缓存: 存储局域网中IP与MAC的映射
+ 发送信息时网络层给出IP地址, 主机链路层**根据高速缓存查询MAC地址**
+ 如果缓存中**查不到**, **广播APR请求分组**:  发送当前IP, 被查IP, 当前MAC, 全1MAC(广播), 目标收到后会**单播ARP响应分组**: 回复被查IP, 被查MAC. 查到则发送数据帧, 包含: 当前IP, 目标IP, 当前MAC, 目标MAC. 
+ 如果**没有响应**, 不在一个网段, 则主机**ARP广播查询默认网关的MAC地址**(不是交换机/集线器等链路层设备, 只能跳到路由器等网络层设备), 查到后发送数据帧, 包含: 当前IP, 目标IP, 当前MAC, **网关MAC**. 
+ 路由器再转发, 源IP, 目的IP不变, MAC都变. 



# 网络层: IP协议

## IP数据报头部

+ **首部**分为两部分: 固定部分(共20B, 160位), 可变部分
+ ![在这里插入图片描述](https://img-blog.csdnimg.cn/20200628163753975.png?shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTA2NzYwMw==,size_16,color_FFFFFF,t_70)



|              名称               |                             注释                             |            大小             |
| :-----------------------------: | :----------------------------------------------------------: | :-------------------------: |
|          版本 Version           |                         ipv4或者ipv6                         |             4位             |
|          首部长度 IHL           | 此处数值再乘以4才是真正大小，同时因为IP数据报固定长度为20字节，所以此处最小值为5，即二进制的0101 |             4位             |
|       区分服务 DSCP + ECN       |                 希望获得哪种服务，用的比较少                 |             8位             |
|       总长度 Total Length       |             首部+数据的长度，最大为2^16-1=65535              |            16位             |
|       标识 Identification       |   用来表示是哪一个数据报的分片，同一数据报分片使用同一标识   |            16位             |
|           标志 Flags            | 用来表示是否分片和分片是否结束, 中间位: DF禁止分片(1禁止0允许); 最低位: MF更多分片(1还有0没了) | 3位，但实际有用的只有后两位 |
|     片偏移 Fragment Offset      | 用来标记分片之后，该分片在原来的数据报的位置，以8字节为单位. |            13位             |
|      生存时间 Time To Live      | 即TTL，没经过一个路由器TTL-1,0时自动放弃，根据系统不同默认的TTL不同 |             8位             |
|          协议 Protocol          |      用来标记数据部分协议名的字段值，如TCP,UDP,ICMP等等      |             8位             |
|   首部检验和 Header Checksum    |          检验首部的字段是否出错，出错就丢弃此数据报          |            16位             |
|    源地址 Source IP Address     |                         发送方ip地址                         |            32位             |
| 目的地址 Destination IP Address |                         接收方ip地址                         |            32位             |
|        可选字段 Options         |                      用来排错等安全检测                      |    未知，可在0-40位之间     |
|              填充               |           将数据报对齐成4字节的整数倍，数值全部为0           |   未知，根据可选字段来定    |



## IP分片

+ 以太网的MTU是1500B
+ 标识不变
+ 片偏移 = 之前所有字节数 / 8B



## IPv6

+ ![](https://cdn.jsdelivr.net/gh/SalmonC/PicBed@main/1626265126170-1626265126122.png)



# 网络层: ICMP协议

![](https://cdn.jsdelivr.net/gh/SalmonC/PicBed@main/1626261235164-1626261235136.png)

1. ICMP，IGMP处于网络层和传输层之间，就是为了更好地转发ip数据报和提高交互成功的几率
2. 支持主机或路由器
3. 通过发送特定ICMP报文, 进行差错或异常报告/网络探询
4. ICMP报文作为IP数据报的数据部分发送(数据报分为首部和数据部分)
5. ![报文格式](https://cdn.jsdelivr.net/gh/SalmonC/PicBed@main/1626261396849-1626261396813.png)

### 5种差错报文

1. **终点不可达**: *<u>无法交付</u>* 路由器或主机无法交付数据, 向**源点**发送终点不可达报文
2. **源点抑制(已弃用)**: *<u>拥塞丢数据</u>* 由于拥塞而丢弃数据, 向源点发送源点抑制, 让远点减缓发送速率
3. **时间超过**:*<u>TTL = 0</u>* 两种情况.  路由器收到`TTL = 0`的数据报时, 丢弃该数据报, 并向源点发送; 如果终点在预先超过的时间内不能收到一个数据报的全部数据片, 丢弃所有数据片, 发送时间超过报文. 
4. **参数问题**: *<u>首部字段有问题</u>* 路由器或主机收到的首部有字段值不正确, 丢弃数据报并发数报文
5. **改变路由(重定向)**: *<u>值得更好的路由</u>* 路由器把改变路由报文发送给主机, 让主句指定下次将数据报发送给另外的路由器. 

+ **差错报告报文字段** (先收到一个**需要差错报告**的IP数据报)

  ![在这里插入图片描述](https://img-blog.csdnimg.cn/20200629094024680.png?shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTA2NzYwMw==,size_16,color_FFFFFF,t_70)

  + 把收到的IP数据报首部+前8个字节取出, 作为ICMP报文的数据字段
  + 为数据字段添加ICMP首部, 长度为8字节, 作为ICMP报文的全部
  + 为ICMP报文添加IP数据报首部, 作为IP数据报全部

+ 不发送差错报告报文的情况

  1. **ICMP差错报告报文**出错时, 不再发送差错报文
  2. 一个分片发送过报文后, 后续分片不发送
  3. 对具有**组播地址**的数据报不发送
  4. 对具有特殊地址(127.0.0.0 或0.0.0.0)的数据报不发送



### 4种询问报文

1. **回送请求和回答报文** : 主机或路由器向特定目的主机发送出的询问, 收到次报文的主机必须给源路由器或主机发送**回答报文**. 比如`ping`命令
2. **时间戳请求和回答报文** : 请某个主机或路由器回答当前的日期时间. 用来进行时钟同步和测量时间
3. 掩码地址请求和回答报文 : 停止使用
4. 路由器请求和通告报文 : 停止使用



# 传输层 : UDP

+ 特点: 

  + **无连接**, 减少开销和发送前时延

  + **不保证可靠交付**, 尽最大努力交付

  + **面向报文**, 适合一次性传输少量数据的应用

    + 面向报文: 对应用层报文既不合并也不拆分, 不做任何改变, 保留边界

    + 所以要**选择合适的报文长度**, 太长网络层会分片, 降低效率; 太短, 数据报占比太小, 效率低

  + **无拥塞控制**, 适合很多实时应用

+ 首部格式: 

  ![](https://cdn.jsdelivr.net/gh/SalmonC/PicBed@main/1626333330529-1626333330514.png)

  + 源端口号: 可有可无
  + 目的端口号: 必须有
  + UDP长度: 首部加字段总长度, 单位是B
  + 检验和: 检验是否出错(发送端和接收端计算检验和时会添加伪IP首部, 计算后删掉伪首部)



# 传输层 : TCP

## TCP特点

+ 面向连接
+ 点对点
+ 可靠有序, 不丢不重
+ 全双工
+ 面向字节流



## 首部格式

+ 20B的**固定首部**+可有可无的可变长度+填充(至4B的倍数)
+ ![](https://cdn.jsdelivr.net/gh/SalmonC/PicBed@main/1626334954446-1626334954428.png)

1. **源端口和目的端口** : 各占2个字节，分别写入源端口和目的端口。
2. **序号** : 占4字节。表示本报文段数据部分第一个字节的序号, **从0开始**, 一般第一个序号是随机的, 后面的累加
3. **确认号** : 占4字节，是期望收到对方下一个报文段的第一个数据字节的序号。若确认号为= N，则表明：到序号N-1为止的所有数据都已正确收到。
4. **数据偏移/首部长度** : 占4位，它指出TCP报文段的数据起始处**距离TCP报文段的起始处**有多远。这个字段实际上是指出TCP报文段的首部长度。单位为4B. 
5. **保留** : 占6位，保留为今后使用，但目前应置为0 。
6. 6个**控制位**
7. **窗口** : 占2字节。窗口指的是**发送本报文段的一方的接受窗口**（而不是自己的发送窗口）。窗口值告诉对方：从本报文段首部中的确认号算起，接收方目前允许对方发送的数据量（以字节为单位）。窗口字段明确指出了现在允许对方发送的数据量。窗口值经常在动态变化。
8. **检验和** : 占2字节。检验和字段检验的范围包括首部和数据这两部分。和UDP用户数据报一样，在计算检验和时，要在TCP报文段的前面加上12字节的**伪首部**。伪首部的格式和UDP用户数据报的伪首部一样。但应把伪首部第4个字段中的17改为6（TCP的协议号是6）
9. **紧急指针** : 占2字节。紧急指针仅在URG=1时才有意义，它指出本报文段中的**紧急数据的字节数**（紧急数据结束后就是普通数据）。因此，在紧急指针指出了紧急数据的末尾在报文段中的位置。当所有紧急数据都处理完时，TCP就告诉应用程序恢复到正常操作。值得注意的是，即使窗口为0时也可以发送紧急数据。
10. **选项** : 长度可变，最长可达4字节。当没有使用“选项”时，TCP的首部长度是20字节。

       TCP最初只规定了一种选项，即最大报文段长度MSS（Maximum Segment Szie）。注意MSS这个名词含义。MSS是每一个TCP报文段中的数据字段的最大长度。数据字段加上TCP首部才等于整个的TCP报文段。所以MSS并不是整个TCP报文段的最大长度，而是“TCP报文段长度减去TCP首部长度”。



+ 控制位: 
  + URG紧急位: 为1时, 表明**发送方**有紧急数据, 高优先级, 尽快**传送**, 不应在缓存排队, 配合紧急指针使用. 
  + ACK确认位: 为1时, 确认号才有效; 连接建立后所有报文段都应置为1. 
  + PSH推送位: 相对URG, 表示在接收方紧急处理, 交给上层
  + RST复位: 表明TCP连接出现严重差错, 需要释放连接, 重新建立连接
  + SYN同步位: 表明是一个连接请求/连接接受报文
  + FIN终止位: 表明报文发送结束, 释放连接



## TCP连接管理

+ TCP连接采用客户/服务器(Client/Server)方式, 主动发起连接的叫客户

### 三次握手(建立连接)

+ ![](https://cdn.jsdelivr.net/gh/forthespada/mediaImage2@1.1/202103/net-55-1.png)

+ 重要字段:

  + SYN同步位
  + seq = x: 序号随机
  + ACK确认位
  + ack : 确认号随机

  ![](https://cdn.jsdelivr.net/gh/SalmonC/PicBed@main/1626337905984-1626337905973.png)

  



### 四次挥手(断开连接)

![](https://cdn.jsdelivr.net/gh/forthespada/mediaImage2@1.0/202103/net-61-1.png)



### 滑动窗口

+ 接收方每次回复都指明下一次接受序号ack和后续接收窗口rwnd, rwnd为0时停止接受数据
+ 每当有一方收到对方的零窗口通知, 启动持续计时器, 计时器到期时发送一个零窗口探测报文段, 接收方收到之后给出当前窗口值. 如果仍是0, 重新计时. 



### 拥塞控制

+ 4种方式: 慢开始, 拥塞避免, 快重传, 快恢复



# 应用层 : HTTP

+ HTTP是面向文本的, 报文中每个字段都是ASCII码串
+ 报文格式

![](https://cdn.jsdelivr.net/gh/SalmonC/PicBed@main/1626441247165-1626441247103.png)



![](https://cdn.jsdelivr.net/gh/SalmonC/PicBed@main/1626441383106-1626441383080.png)



+ 状态码
  ![image-20210716211809601](/Users/SalmonC/Pictures/PicBed/MDImage/image-20210716211809601.png)

